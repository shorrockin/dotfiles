#!/usr/bin/env bash
# Push-to-talk dictation wrapper for Hyprland + Quickshell
# Usage: dictation start|stop|reset

# Resolve paths dynamically from the installed hyprflow nix package
HYPRFLOW_BIN="$(command -v hyprflow 2>/dev/null)"
if [ -z "$HYPRFLOW_BIN" ]; then
    echo "Error: hyprflow not found in PATH" >&2
    exit 1
fi
HYPRFLOW_PKG="$(dirname "$(dirname "$(readlink -f "$HYPRFLOW_BIN")")")"

# whisper-cli path is baked into the hyprflow script at build time
WHISPER_BIN="$(sed -n 's/^WHISPER_BIN="\(.*\)"/\1/p' "$HYPRFLOW_PKG/bin/.hyprflow-wrapped")"
WHISPER_MODEL="$HYPRFLOW_PKG/share/hyprflow/ggml-base.en.bin"

if [ ! -x "$WHISPER_BIN" ]; then
    echo "Error: whisper-cli not found at $WHISPER_BIN" >&2
    exit 1
fi
RECORDING_DIR="$HOME/.cache/hyprflow/recordings"
TRANSCRIPT_DIR="$HOME/.cache/hyprflow/transcripts"
STATE_FILE="/tmp/dictation.state"
KEEP_VERSIONS=5

mkdir -p "$RECORDING_DIR" "$TRANSCRIPT_DIR"

start_recording() {
    # Don't start if already recording
    if [ -f "$STATE_FILE" ]; then
        return 0
    fi

    TIME=$(date +%s)
    echo "TIME=$TIME" > "$STATE_FILE"
    RECORDING_FILE="${RECORDING_DIR}/${TIME}.wav"

    # Start recording
    wpctl set-mute @DEFAULT_AUDIO_SINK@ 1
    pw-record --rate 16000 --channels 1 "$RECORDING_FILE" 2>/dev/null &
    echo "PID=$!" >> "$STATE_FILE"
}

stop_recording() {
    # Don't stop if not recording
    if [ ! -f "$STATE_FILE" ]; then
        return 0
    fi

    source "$STATE_FILE"

    # Stop recording
    if [ -n "$PID" ]; then
        kill "$PID" 2>/dev/null
    fi
    pkill -f "pw-record.*hyprflow" 2>/dev/null
    wpctl set-mute @DEFAULT_AUDIO_SINK@ 0

    rm -f "$STATE_FILE"

    RECORDING_FILE="${RECORDING_DIR}/${TIME}.wav"
    TRANSCRIPT_FILE="${TRANSCRIPT_DIR}/${TIME}_raw.txt"

    if [ -f "$RECORDING_FILE" ]; then
        # Transcribe
        "$WHISPER_BIN" -m "$WHISPER_MODEL" -f "$RECORDING_FILE" \
            --no-prints --no-timestamps > "$TRANSCRIPT_FILE" 2>/dev/null

        # Clean up, copy to clipboard, and paste
        TEXT=$(sed 's/^[[:space:]]*//;s/[[:space:]]*$//' "$TRANSCRIPT_FILE" | tr -d '\n')

        if [ -n "$TEXT" ]; then
            echo -n "$TEXT" | wl-copy
            # Small delay to ensure clipboard is ready
            sleep 0.1
            hyprctl dispatch sendshortcut "CTRL SHIFT, V, activewindow"
        fi
    fi

    # Cleanup old files
    if [ "$KEEP_VERSIONS" -gt 0 ]; then
        ls -1t "$RECORDING_DIR"/*.wav 2>/dev/null | tail -n +$((KEEP_VERSIONS + 1)) | xargs -r rm -f
        ls -1t "$TRANSCRIPT_DIR"/*_raw.txt 2>/dev/null | tail -n +$((KEEP_VERSIONS + 1)) | xargs -r rm -f
    fi
}

case "${1:-}" in
    start)
        start_recording
        ;;
    stop)
        stop_recording
        ;;
    reset)
        wpctl set-mute @DEFAULT_AUDIO_SINK@ 0
        rm -f "$STATE_FILE"
        ;;
    *)
        echo "Usage: dictation start|stop|reset"
        exit 1
        ;;
esac