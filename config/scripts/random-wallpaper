#!/usr/bin/env bash

WALLPAPER_DIR="$HOME/.config/assets/wallpapers/"
CACHE_FILE="$HOME/.cache/current_wallpaper"

export DISPLAY=:0
export XDG_RUNTIME_DIR=/run/user/$(id -u)
export WAYLAND_DISPLAY=wayland-1

# Get current wallpaper from cache (if exists)
CURRENT_WALL=""
if [[ -f "$CACHE_FILE" ]]; then
    CURRENT_WALL=$(cat "$CACHE_FILE")
fi

# Get a random wallpaper that is not the current one
WALLPAPER=$(find "$WALLPAPER_DIR" -type f ! -path "$CURRENT_WALL" | shuf -n 1)

# Save the selected wallpaper path
echo "$WALLPAPER" > "$CACHE_FILE"

# Preload the wallpaper first (required by hyprpaper for IPC)
/run/current-system/sw/bin/hyprctl hyprpaper preload "$WALLPAPER"

# Apply the selected wallpaper (empty monitor = all monitors)
/run/current-system/sw/bin/hyprctl hyprpaper wallpaper ", $WALLPAPER"

# Unload previous wallpaper to free memory
if [[ -n "$CURRENT_WALL" && "$CURRENT_WALL" != "$WALLPAPER" ]]; then
    /run/current-system/sw/bin/hyprctl hyprpaper unload "$CURRENT_WALL"
fi
