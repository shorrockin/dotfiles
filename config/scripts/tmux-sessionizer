#!/usr/bin/env bash

# History file for tracking recency
HISTORY_FILE="$HOME/.cache/tmux-sessionizer-history"
CONFIG_FILE="$HOME/.tmux-sessionizer.conf"

# Ensure cache directory exists
mkdir -p "$(dirname "$HISTORY_FILE")"

# Show help message
show_help() {
    cat << 'EOF'
tmux-sessionizer - Fast tmux session switcher with config-driven project management

USAGE:
    tmux-sessionizer [OPTIONS] [DIRECTORY]

DESCRIPTION:
    Interactive fuzzy finder for switching between tmux sessions and configured projects.
    Uses a config file to map session names to directories for fast, predictable access.

OPTIONS:
    help, --help, -h    Show this help message

ARGUMENTS:
    DIRECTORY           Optional: Directly open a specific directory without interactive selection

CONFIGURATION:
    Config file: ~/.tmux-sessionizer.conf
    Format: session_name=/path/to/directory

    Config entries are displayed as: session_name (directory)
    Active tmux sessions are marked with: ● session_name

    Example:
        # Comment lines start with #
        dotfiles=/Users/username/dotfiles
        work-project=/Users/username/work/main-app
        personal=/Users/username/projects/blog

    Each line maps a session name (left of =) to a directory path (right of =).
    Session names can be anything you want - they don't need to match directory names.

    Notes:
    • Do not use ● (bullet) in session names - it's reserved for marking active sessions
    • Config entries for already-active sessions won't be shown (avoids duplicates)

FEATURES:
    • Configuration-driven: Only shows projects you explicitly configure
    • History-based sorting: Most recently used sessions appear first
    • Session list: Shows existing tmux sessions (marked with ●) alongside configured projects
    • Fast startup: No file system scanning or preview overhead, near-instant (10-30ms)
    • Interactive fuzzy search: Quickly find and switch between sessions

KEYBINDINGS (in fzf):
    Ctrl+J/K or ↑↓     Navigate up/down
    Enter              Select and switch to session
    Ctrl+C or Esc      Cancel selection

EXAMPLES:
    # Interactive selection
    tmux-sessionizer

    # Direct selection (bypass fzf)
    tmux-sessionizer ~/projects/myapp

    # Generate initial config from a directory
    for dir in ~/work/*; do
        [[ -d "$dir" ]] && echo "$(basename "$dir")=$dir"
    done > ~/.tmux-sessionizer.conf

    # Add current directory to config
    echo "$(basename "$PWD")=$PWD" >> ~/.tmux-sessionizer.conf

FILES:
    ~/.tmux-sessionizer.conf            Configuration file (session_name=directory pairs)
    ~/.cache/tmux-sessionizer-history   History file (50 most recent selections)

SEE ALSO:
    tmux(1), fzf(1)
EOF
}

# Read configuration file and output session_name:directory pairs
read_config() {
    if [[ ! -f "$CONFIG_FILE" ]]; then
        echo "Warning: Config file $CONFIG_FILE not found. Create it with format: session_name=/path/to/directory" >&2
        return
    fi

    while IFS='=' read -r session_name directory; do
        # Skip empty lines and comments
        [[ -z "$session_name" || "$session_name" =~ ^[[:space:]]*# ]] && continue

        # Trim whitespace
        session_name=$(echo "$session_name" | xargs)
        directory=$(echo "$directory" | xargs)

        # Validate directory exists
        if [[ -d "$directory" ]]; then
            echo "${session_name}:${directory}"
        else
            echo "Warning: Skipping invalid directory: $directory" >&2
        fi
    done < "$CONFIG_FILE"
}

# Function to update history with the selected item
update_history() {
    local item="$1"
    local temp_file="${HISTORY_FILE}.tmp.$$"

    # Single pass: add new item to front, remove duplicates, truncate to 50
    {
        echo "$item"
        if [[ -f "$HISTORY_FILE" ]]; then
            grep -vF "$item" "$HISTORY_FILE" 2>/dev/null | head -49
        fi
    } > "$temp_file"

    mv "$temp_file" "$HISTORY_FILE"
}

# Function to get items sorted by recency
get_sorted_items() {
    local all_items="$1"

    if [[ ! -f "$HISTORY_FILE" ]]; then
        echo "$all_items"
        return
    fi

    # Build associative array for O(1) lookups
    declare -A all_map
    while IFS= read -r item; do
        [[ -n "$item" ]] && all_map["$item"]=1
    done <<< "$all_items"

    # Output history items first (newest to oldest)
    while IFS= read -r item; do
        if [[ -n "$item" ]] && [[ -n "${all_map[$item]}" ]]; then
            echo "$item"
            unset all_map["$item"]
        fi
    done < <(tac "$HISTORY_FILE" 2>/dev/null)

    # Output remaining non-history items
    for item in "${!all_map[@]}"; do
        echo "$item"
    done
}

# Handle help command
if [[ "$1" == "help" ]] || [[ "$1" == "--help" ]] || [[ "$1" == "-h" ]]; then
    show_help
    exit 0
fi

if [[ $# -eq 1 ]]; then
    selected=$1
else
    # Get configured directories from config file
    config_entries=$(read_config)

    # Get existing tmux sessions (with ● marker)
    declare -A existing_sessions
    if pgrep -x tmux > /dev/null; then
        sessions=$(tmux ls -F "#{session_name}" 2>/dev/null)
        while IFS= read -r session; do
            existing_sessions["$session"]=1
        done <<< "$sessions"
    fi

    # Combine: sessions first (marked with ●), then configured entries (session_name (directory))
    # Skip config entries where session already exists
    all_items=$(
        if [[ -n "$sessions" ]]; then
            echo "$sessions" | while read -r session; do
                echo "● ${session}"  # Mark tmux sessions with ● and space
            done
        fi
        echo "$config_entries" | while IFS=: read -r session_name directory; do
            # Only show if session doesn't already exist
            if [[ -z "${existing_sessions[$session_name]}" ]]; then
                echo "${session_name} (${directory})"
            fi
        done
    )

    # Sort items by recency
    sorted_items=$(echo "$all_items" | get_sorted_items "$all_items")

    # Display with fzf (no preview for speed)
    selected=$(echo "$sorted_items" | fzf --height=100% --layout=reverse --tiebreak=index | awk 'END {print}')
fi

if [[ -z $selected ]]; then
    exit 0
fi

# Parse selection: format is either "● session_name" or "session_name (directory)"
if [[ "$selected" =~ ^●[[:space:]](.+)$ ]]; then
    # Existing tmux session
    session_name="${BASH_REMATCH[1]}"
    update_history "● ${session_name}"
else
    # Configured directory entry: session_name (directory)
    if [[ "$selected" =~ ^(.+)[[:space:]]\((.+)\)$ ]]; then
        session_name="${BASH_REMATCH[1]}"
        selected_path="${BASH_REMATCH[2]}"
    else
        echo "Error: Invalid selection format: $selected" >&2
        exit 1
    fi

    if [[ ! -d "$selected_path" ]]; then
        echo "Error: Invalid directory path for session $session_name: $selected_path" >&2
        exit 1
    fi

    update_history "$selected"

    # Create session if it doesn't exist
    if ! tmux has-session -t="$session_name" 2> /dev/null; then
        tmux new-session -ds "$session_name" -c "$selected_path"
    fi
fi

# Switch to session
if [[ -z $TMUX ]]; then
    tmux attach -t "$session_name"
else
    tmux switch-client -t "$session_name"
fi
