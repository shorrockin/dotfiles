# ============================================================================
# PLUGIN MANAGER & PLUGINS
# ============================================================================
# Plugin manager: https://github.com/tmux-plugins/tpm
# Install plugins: prefix + I
set -g @plugin "tmux-plugins/tpm"
set -g @plugin "tmux-plugins/tmux-sensible"

# Theme: https://github.com/omerxx/catppuccin-tmux
# Has some tweaks which make for better styling than the official plugin
set -g @plugin "omerxx/catppuccin-tmux"

# Vim/Tmux Navigator: https://github.com/christoomey/vim-tmux-navigator
# Seamlessly navigate between tmux panes and vim splits with Ctrl+[hjkl]
set -g @plugin "christoomey/vim-tmux-navigator"

# Session Resurrect: https://github.com/tmux-plugins/tmux-resurrect
# Save: prefix + Ctrl-s | Restore: prefix + Ctrl-r
# Auto-saves every 15 minutes via continuum
set -g @plugin "tmux-plugins/tmux-resurrect"

# Continuum: https://github.com/tmux-plugins/tmux-continuum
# Auto-save every 15 minutes and restore sessions on tmux start
set -g @plugin "tmux-plugins/tmux-continuum"

# Nerd Font Window Names: https://github.com/joshmedeski/tmux-nerd-font-window-name
set -g @plugin "joshmedeski/tmux-nerd-font-window-name"

# Tmux Thumbs: https://github.com/fcsonline/tmux-thumbs
# Easy copy/paste text from tmux buffer
# Usage: prefix + space (default binding)
set -g @plugin 'fcsonline/tmux-thumbs'

# ============================================================================
# PLUGIN CONFIGURATION
# ============================================================================

# Continuum Settings
set -g @continuum-restore "on"
# set -g @continuum-boot "on" # Auto-start tmux on system boot

# Thumbs Settings - copy to system clipboard (cross-platform)
if-shell 'uname | grep -q Darwin' \
  'set -g @thumbs-command "echo -n {} | pbcopy"' \
  'set -g @thumbs-command "echo -n {} | wl-copy"'

# Disable vim-tmux-navigator's C-\ binding (we use it for nested session toggle)
set -g @vim_navigator_mapping_prev ""

# Catppuccin Theme Settings
set -g @catppuccin_flavour "mocha"

# Window formatting
set -g @catppuccin_window_left_separator " "
set -g @catppuccin_window_right_separator ""
set -g @catppuccin_window_middle_separator "█ "
set -g @catppuccin_window_number_position "left"
set -g @catppuccin_window_default_fill "number"
set -g @catppuccin_window_default_text "#W"
set -g @catppuccin_window_current_fill "number"
set -g @catppuccin_window_current_text "#W"

# Status bar formatting
set -g @catppuccin_status_modules_right "directory session"
set -g @catppuccin_status_left_separator  " "
set -g @catppuccin_status_right_separator ""
set -g @catppuccin_status_right_separator_inverse "no"
set -g @catppuccin_status_fill "icon"
set -g @catppuccin_status_connect_separator "no"
set -g @catppuccin_directory_text "#(~/.config/scripts/short-path '#{pane_current_path}')"

# ============================================================================
# TERMINAL & DISPLAY SETTINGS
# ============================================================================

# Terminal color support for both tmux and nvim
set -g default-terminal "screen-256color"
set -as terminal-features ",xterm-256color:RGB"

# Faster command sequences (better vim responsiveness)
set -sg escape-time 10

# Increase scrollback buffer
set -g history-limit 50000

# Display tmux messages for 4 seconds
set -g display-time 4000

# Status bar position
set-option -g status-position top

# Mouse support (requires tmux 2.1+)
set -g mouse on

# Focus events for nvim integration (enables tint plugin to fade inactive panes)
set -g focus-events on

# Allow passthrough for clipboard and kitty graphics protocol (for fastfetch images)
set -g allow-passthrough on

# Extended keys for CSI u / kitty keyboard protocol (enables Ctrl+digit passthrough)
set -g extended-keys on

# Native clipboard integration (tmux 2.6+)
set -g set-clipboard on

# ============================================================================
# PREFIX & BASIC OPTIONS
# ============================================================================

# Set prefix to ` instead of C-b (better ergonomics for Kinesis)
unbind C-b
set-option -g prefix `
bind ` send-prefix

# Don't detach from tmux when destroying a session; switch to next session
set-option -g detach-on-destroy off

# Start window and pane numbering at 1 instead of 0
set -g base-index 1
set -g pane-base-index 1
set-window-option -g pane-base-index 1
set-option -g renumber-windows on

# ============================================================================
# KEY BINDINGS - PANE & WINDOW MANAGEMENT
# ============================================================================

# Pane splitting
bind - split-window -v
bind _ split-window -h

# Quick window selection with Ctrl+[1-5]
bind-key -n C-1 select-window -t 1
bind-key -n C-2 select-window -t 2
bind-key -n C-3 select-window -t 3
bind-key -n C-4 select-window -t 4
bind-key -n C-5 select-window -t 5

# Quick window selection with Alt+[1-5]
bind-key -n M-1 select-window -t 1
bind-key -n M-2 select-window -t 2
bind-key -n M-3 select-window -t 3
bind-key -n M-4 select-window -t 4
bind-key -n M-5 select-window -t 5

# Pane navigation (works with vim-tmux-navigator)
bind -r h select-pane -L  # Move left
bind -r j select-pane -D  # Move down
bind -r k select-pane -U  # Move up
bind -r l select-pane -R  # Move right

# Pane swapping
bind > swap-pane -D       # Swap current pane with the next one
bind < swap-pane -U       # Swap current pane with the previous one

# Pane resizing
bind -r H resize-pane -L 2
bind -r J resize-pane -D 2
bind -r K resize-pane -U 2
bind -r L resize-pane -R 2

# Window navigation
bind -r S-Left select-window -t -1
bind -r S-Right select-window -t +1

# Move current window left or right
bind -r P swap-window -t -1\; select-window -t -1
bind -r N swap-window -t +1\; select-window -t +1

# ============================================================================
# KEY BINDINGS - SESSION MANAGEMENT
# ============================================================================

# Session switcher with fuzzy finder (bound to both prefix+s and Ctrl-s)
bind s display-popup -w 50% -h 50% -E "~/.config/scripts/tmux-sessionizer"
bind-key -n C-s display-popup -w 50% -h 50% -E "~/.config/scripts/tmux-sessionizer"

# Quick toggle to last session
bind-key -n C-0 switch-client -l

# ============================================================================
# KEY BINDINGS - UTILITY
# ============================================================================

# Reload configuration file
bind r source-file ~/.tmux.conf

# Re-enable automatic window naming
bind A setw automatic-rename on

# Refresh tmux client and clear history
bind-key -n C-b send-keys -R \; clear-history

# ============================================================================
# COPY MODE SETTINGS
# ============================================================================

set-window-option -g mode-keys vi
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind-key -T copy-mode-vi y send-keys -X copy-selection-and-cancel

# ============================================================================
# PLUGIN MANAGER INITIALIZATION (keep at bottom)
# ============================================================================

run "~/.tmux/plugins/tpm/tpm"

# ============================================================================
# NESTED SESSION TOGGLE (must be after TPM to override plugin bindings)
# ============================================================================
# Toggle passthrough mode for nested tmux sessions (e.g., over SSH).
# When active, all keybindings forward to the inner tmux.
# C-\ to toggle. C-s and C-0 remain available for session navigation.


# Enter passthrough: disable prefix, switch to off key-table, dim status bar
bind-key -T root C-\\ \
    set prefix None \;\
    set key-table off \;\
    set status-style "fg=#585b70,bg=#181825" \;\
    set status-position bottom \;\
    set status-left "" \;\
    set status-right "#[fg=#f38ba8,bg=default]#[bg=#f38ba8,fg=#1e1e2e,bold] REMOTE #[fg=#f38ba8,bg=default]" \;\
    set window-status-current-format "" \;\
    set window-status-format "" \;\
    set pane-active-border-style "fg=#45475a" \;\
    if -F '#{pane_in_mode}' 'send-keys -X cancel' \;\
    refresh-client -S

# Exit passthrough: restore prefix and key-table (set -u falls back to globals)
bind-key -T off C-\\ \
    set -u prefix \;\
    set -u key-table \;\
    set -u status-style \;\
    set -u status-position \;\
    set -u status-left \;\
    set -u status-right \;\
    set -u window-status-current-format \;\
    set -u window-status-format \;\
    set -u pane-active-border-style \;\
    refresh-client -S

# Keep session navigation available in passthrough mode
bind-key -T off C-s display-popup -w 50% -h 50% -E "~/.config/scripts/tmux-sessionizer"
bind-key -T off C-0 switch-client -l

# Pass through Ctrl+[1-5] window selection keys in remote mode
# Uses CSI u escape sequences (kitty keyboard protocol) for Ctrl+digit
bind-key -T off C-1 send-keys "\e[49;5u"
bind-key -T off C-2 send-keys "\e[50;5u"
bind-key -T off C-3 send-keys "\e[51;5u"
bind-key -T off C-4 send-keys "\e[52;5u"
bind-key -T off C-5 send-keys "\e[53;5u"

# Pass through Alt+[1-5] as well
bind-key -T off M-1 send-keys "\e[49;3u"
bind-key -T off M-2 send-keys "\e[50;3u"
bind-key -T off M-3 send-keys "\e[51;3u"
bind-key -T off M-4 send-keys "\e[52;3u"
bind-key -T off M-5 send-keys "\e[53;3u"
